# Keyball Gestures アーキテクチャ設計

このドキュメントでは、Keyball Gesturesのアーキテクチャと内部設計について説明します。

## 全体アーキテクチャ

Keyball Gesturesは、CLIアプリケーションとAPIサーバーの2つの動作モードを持つバックエンドシステムとして設計されています。バックエンドはFlutterで構築されたフロントエンドアプリケーションと連携することを想定しています。

```
┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │
│  Flutter        │     │  CLI モード     │
│  フロントエンド │     │  (スタンドアロン)│
│                 │     │                 │
└────────┬────────┘     └─────────────────┘
         │                        ▲
         │ HTTP API               │
         ▼                        │
┌─────────────────┐               │
│                 │               │
│  API サーバー   │───────────────┘
│  モード         │  内部API呼び出し
│                 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│                 │
│  ジェスチャー   │
│  認識サービス   │
│                 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│                 │
│  Linux入力      │
│  サブシステム   │
│  (/dev/uinput)  │
└─────────────────┘
```

## 主要コンポーネント

### 1. コマンドライン (cmd/main.go)

エントリーポイントとなるコンポーネント。コマンドライン引数を解析し、CLIモードかAPIサーバーモードのどちらかで起動します。設定ファイルのロードや基本的な初期化処理も担当します。

### 2. 設定管理 (internal/config)

設定ファイル（TOML形式）の読み込み、保存、デフォルト値の提供を担当します。以下の設定項目をサポートしています：

- タッチパッド設定（範囲など）
- 入力設定（トリガーキー）
- モーション設定（フィルター係数など）
- ジェスチャー設定（リセット閾値など）
- デバイス設定（優先デバイス）

### 3. APIサーバー (internal/api)

HTTPベースのRESTful APIを提供し、外部（特にFlutterフロントエンド）からのリクエストを処理します。

- **server.go**: HTTPサーバーの初期化と管理
- **routes.go**: APIエンドポイントのルーティングとハンドラ実装
- **service.go**: ジェスチャー認識サービスの実装

### 4. 機能モジュール (internal/features)

ジェスチャー認識の中核となる機能を実装します：

- **devices.go**: 入力デバイスの検出と管理
- **keyboard.go**: キーボード入力の処理
- **mouse.go**: マウス入力の処理
- **touchpad.go**: 仮想タッチパッドの実装
- **motion_filter.go**: 動きの平滑化フィルター

### 5. 型定義とユーティリティ (internal/types, internal/utils)

汎用的な型定義やユーティリティ関数を提供します。

## データフロー

### 1. CLIモード

1. ユーザーがCLIモードでアプリケーションを起動
2. 設定ファイルをロード
3. 入力デバイス（キーボード、マウス）を検出
4. 仮想タッチパッドデバイスを作成
5. トラックボール（マウス）からの入力を監視し、特定のキー（F13/F14）と組み合わせてジェスチャーとして解釈
6. ジェスチャーを仮想タッチパッドイベントに変換
7. 仮想タッチパッドイベントをLinuxのuinputシステムに送信

### 2. APIサーバーモード

1. ユーザーがAPIサーバーモードでアプリケーションを起動
2. HTTPサーバーを初期化（デフォルトポート：8080）
3. APIエンドポイントを設定
4. クライアント（Flutterフロントエンド）からのリクエストを待機
5. リクエストに応じて以下の処理を実行：
   - 設定の取得/更新/保存
   - デバイス一覧の取得
   - ジェスチャー認識サービスの開始/停止
   - サービス状態の取得

### ジェスチャー認識サービス (共通)

1. 入力デバイスからの信号（マウス移動とキー押下）を監視
2. モーションフィルターを適用して動きを平滑化
3. ジェスチャーのタイプ（2本指/4本指）と方向を判断
4. 適切な仮想タッチパッドイベントを生成
5. 生成したイベントをuinputシステムに送信

## 設定ファイル

設定はTOML形式で、`~/.config/keyball-gestures/config.toml`（デフォルト）に保存されます。設定ファイルは以下のセクションで構成されています：

```toml
[touchpad]
min_x = 0
max_x = 32767
min_y = 0
max_y = 32767

[input]
two_finger_key = 184  # F14
four_finger_key = 183  # F13

[motion]
filter_smoothing_factor = 0.85
filter_warm_up_count = 10
mouse_delta_factor = 15

[gesture]
reset_threshold = "50ms"

[device_prefs]
preferred_keyboard_device = ""
preferred_mouse_device = ""
```

## Flutterフロントエンドとの連携

Flutterフロントエンドは、APIサーバーモードで動作するKeyball Gesturesバックエンドと連携します。主な連携ポイントは以下の通りです：

1. **設定管理**: フロントエンドから設定を取得/更新
2. **デバイス選択**: 利用可能なデバイス一覧を取得し、ユーザーにデバイスを選択させる
3. **サービス制御**: ジェスチャー認識サービスの開始/停止を制御
4. **状態確認**: サービスの現在の状態を取得

フロントエンドはHTTP APIを通じてこれらの操作を行い、バックエンドはRESTful APIとして実装されています。
